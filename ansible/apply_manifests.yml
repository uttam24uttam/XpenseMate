---
- name: Ensure Namespace exists
  command: "kubectl apply -f {{ k8s_dir }}/namespace.yaml"

- name: Apply Base Configurations
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - configmap.yaml
    - secrets.yaml

- name: Apply Databases
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - mongodb-statefulset.yaml
    - redis-deployment.yaml

- name: Wait for Databases to be Ready
  command: "kubectl rollout status {{ item }} -n {{ k8s_namespace }} --timeout=300s"
  loop:
    - statefulset/mongodb
    - deployment/redis

- name: Apply Backend Resources
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - backend-deployment.yaml
    - backend-service.yaml
    - backend-hpa.yaml

- name: Force Backend Restart (Pick up config changes)
  command: "kubectl rollout restart deployment/backend -n {{ k8s_namespace }}"

- name: Wait for Backend Rollout
  command: "kubectl rollout status deployment/backend -n {{ k8s_namespace }} --timeout=300s"

- name: Apply Frontend Resources
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - frontend-deployment.yaml
    - frontend-service.yaml
    - frontend-hpa.yaml
    - ingress.yaml

- name: Force Frontend Restart
  command: "kubectl rollout restart deployment/frontend -n {{ k8s_namespace }}"