---
- name: Namespace Check
  command: "kubectl apply -f {{ k8s_dir }}/namespace.yaml"

- name: Create secrets via kubectl
  shell: |
    kubectl create secret opaque splitwise-secrets \
      --namespace={{ k8s_namespace }} \
      --from-literal=JWT_SECRET="{{ secret_jwt }}" \
      --from-literal=MONGO_USERNAME="{{ secret_mongo_user }}" \
      --from-literal=MONGO_PASSWORD="{{ secret_mongo_pass }}" \
      --from-literal=REDIS_PASSWORD="{{ secret_redis_pass }}" \
      --dry-run=client -o yaml | kubectl apply -f -

- name: Apply Base Configurations
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - configmap.yaml

- name: Apply Databases
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - mongodb-statefulset.yaml
    - redis-deployment.yaml

- name: Database readiness check
  command: "kubectl rollout status {{ item }} -n {{ k8s_namespace }} --timeout=300s"
  loop:
    - statefulset/mongodb
    - deployment/redis

- name: Apply Backend Resources
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - backend-deployment.yaml
    - backend-service.yaml
    - backend-hpa.yaml

- name: Force Backend Restart
  command: "kubectl rollout restart deployment/backend -n {{ k8s_namespace }}"

- name: Wait for Backend Rollout
  command: "kubectl rollout status deployment/backend -n {{ k8s_namespace }} --timeout=300s"

- name: Apply Frontend Resources
  command: "kubectl apply -f {{ k8s_dir }}/{{ item }}"
  loop:
    - frontend-deployment.yaml
    - frontend-service.yaml
    - frontend-hpa.yaml
    - ingress.yaml

- name: Force Frontend Restart
  command: "kubectl rollout restart deployment/frontend -n {{ k8s_namespace }}"