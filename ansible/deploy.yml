---
# Main playbook to deploy Splitwise app to Kubernetes
- name: Deploy Splitwise Application to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    k8s_manifests_dir: "../k8s"
    namespace: "splitwise"
    docker_registry: "{{ docker_registry | default('uttam24uttam') }}"
    backend_image: "{{ backend_image | default(docker_registry + '/splitwise-backend') }}"
    frontend_image: "{{ frontend_image | default(docker_registry + '/splitwise-frontend') }}"
    image_tag: "{{ image_tag | default('latest') }}"

  tasks:
    - name: Display deployment information
      debug:
        msg:
          - "ðŸš€ Starting Kubernetes deployment"
          - "Namespace: {{ namespace }}"
          - "Backend Image: {{ backend_image }}:{{ image_tag }}"
          - "Frontend Image: {{ frontend_image }}:{{ image_tag }}"

    - name: Check if kubectl is installed
      command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Fail if kubectl not found
      fail:
        msg: "âŒ kubectl is not installed. Please install kubectl first."
      when: kubectl_check.rc != 0

    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
            labels:
              name: "{{ namespace }}"
              environment: production
      
    - name: Apply ConfigMaps and Secrets
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/configmap.yaml"

    - name: Deploy MongoDB StatefulSet
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/mongodb-statefulset.yaml"
      
    - name: Wait for MongoDB to be ready
      kubernetes.core.k8s_info:
        kind: StatefulSet
        name: mongodb
        namespace: "{{ namespace }}"
      register: mongodb_status
      until: mongodb_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10
      
    - name: Display MongoDB status
      debug:
        msg: "âœ… MongoDB is ready with {{ mongodb_status.resources[0].status.readyReplicas }} replica(s)"

    - name: Deploy Redis
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/redis-deployment.yaml"

    - name: Wait for Redis to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: redis
        namespace: "{{ namespace }}"
      register: redis_status
      until: redis_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 20
      delay: 10
      
    - name: Display Redis status
      debug:
        msg: "âœ… Redis is ready with {{ redis_status.resources[0].status.readyReplicas }} replica(s)"

    - name: Deploy Backend with updated image
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: "{{ namespace }}"
            labels:
              app: backend
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                containers:
                - name: backend
                  image: "{{ backend_image }}:{{ image_tag }}"
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 5000
                    name: http
                  env:
                  - name: NODE_ENV
                    value: "production"
                  - name: PORT
                    value: "5000"
                  - name: MONGO_URL
                    value: "mongodb://mongodb-service:27017/splitwise"
                  - name: REDIS_HOST
                    value: "redis-service"
                  - name: REDIS_PORT
                    value: "6379"
                  - name: JWT_SECRET
                    valueFrom:
                      secretKeyRef:
                        name: splitwise-secrets
                        key: JWT_SECRET
                  - name: REDIS_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: splitwise-secrets
                        key: REDIS_PASSWORD
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "250m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                  livenessProbe:
                    httpGet:
                      path: /api/users/health
                      port: 5000
                    initialDelaySeconds: 40
                    periodSeconds: 30
                  readinessProbe:
                    httpGet:
                      path: /api/users/health
                      port: 5000
                    initialDelaySeconds: 10
                    periodSeconds: 10

    - name: Ensure Backend Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: backend-service
            namespace: "{{ namespace }}"
          spec:
            type: ClusterIP
            ports:
            - port: 5000
              targetPort: 5000
              protocol: TCP
              name: http
            selector:
              app: backend

    - name: Deploy Backend HPA (Horizontal Pod Autoscaler)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: autoscaling/v2
          kind: HorizontalPodAutoscaler
          metadata:
            name: backend-hpa
            namespace: "{{ namespace }}"
          spec:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: Deployment
              name: backend
            minReplicas: 3
            maxReplicas: 10
            metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: 70
            - type: Resource
              resource:
                name: memory
                target:
                  type: Utilization
                  averageUtilization: 80
            behavior:
              scaleDown:
                stabilizationWindowSeconds: 300
                policies:
                - type: Percent
                  value: 50
                  periodSeconds: 60
              scaleUp:
                stabilizationWindowSeconds: 0
                policies:
                - type: Percent
                  value: 100
                  periodSeconds: 30
                - type: Pods
                  value: 2
                  periodSeconds: 30
                selectPolicy: Max

    - name: Wait for Backend to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: backend
        namespace: "{{ namespace }}"
      register: backend_status
      until: backend_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10
      
    - name: Display Backend status
      debug:
        msg: "âœ… Backend is ready with {{ backend_status.resources[0].status.readyReplicas }} replica(s)"

    - name: Deploy Frontend with updated image
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: "{{ namespace }}"
            labels:
              app: frontend
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: frontend
            template:
              metadata:
                labels:
                  app: frontend
              spec:
                containers:
                - name: frontend
                  image: "{{ frontend_image }}:{{ image_tag }}"
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 80
                    name: http
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "250m"
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 10
                    periodSeconds: 30
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 80
                    initialDelaySeconds: 5
                    periodSeconds: 10

    - name: Ensure Frontend Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: frontend-service
            namespace: "{{ namespace }}"
          spec:
            type: LoadBalancer
            ports:
            - port: 80
              targetPort: 80
              protocol: TCP
              name: http
            selector:
              app: frontend

    - name: Deploy Frontend HPA (Horizontal Pod Autoscaler)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: autoscaling/v2
          kind: HorizontalPodAutoscaler
          metadata:
            name: frontend-hpa
            namespace: "{{ namespace }}"
          spec:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: Deployment
              name: frontend
            minReplicas: 2
            maxReplicas: 5
            metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: 70
            - type: Resource
              resource:
                name: memory
                target:
                  type: Utilization
                  averageUtilization: 80

    - name: Deploy Ingress
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/ingress.yaml"

    - name: Wait for Frontend to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: frontend
        namespace: "{{ namespace }}"
      register: frontend_status
      until: frontend_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10
      
    - name: Display Frontend status
      debug:
        msg: "âœ… Frontend is ready with {{ frontend_status.resources[0].status.readyReplicas }} replica(s)"

    - name: Get all deployments status
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
      register: deployments

    - name: Display all deployments
      debug:
        msg: "{{ item.metadata.name }}: {{ item.status.replicas }}/{{ item.status.readyReplicas | default(0) }} replicas ready"
      loop: "{{ deployments.resources }}"

    - name: Get HPA status
      kubernetes.core.k8s_info:
        kind: HorizontalPodAutoscaler
        namespace: "{{ namespace }}"
      register: hpas

    - name: Display HPA status
      debug:
        msg: 
          - "ðŸ“ˆ HPA: {{ item.metadata.name }}"
          - "   Current: {{ item.status.currentReplicas | default(0) }} replicas"
          - "   Desired: {{ item.status.desiredReplicas | default(0) }} replicas"
          - "   Min: {{ item.spec.minReplicas }} | Max: {{ item.spec.maxReplicas }}"
      loop: "{{ hpas.resources }}"

    - name: Get service endpoints
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ namespace }}"
      register: services

    - name: Display service endpoints
      debug:
        msg: "ðŸŒ Service: {{ item.metadata.name }} | Type: {{ item.spec.type }} | IP: {{ item.spec.clusterIP }}"
      loop: "{{ services.resources }}"

    - name: Final deployment summary
      debug:
        msg:
          - "=========================================="
          - "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
          - "=========================================="
          - "Namespace: {{ namespace }}"
          - "Backend Image: {{ backend_image }}:{{ image_tag }}"
          - "Frontend Image: {{ frontend_image }}:{{ image_tag }}"
          - "Backend HPA: 3-10 replicas (CPU: 70%, Memory: 80%)"
          - "Frontend HPA: 2-5 replicas (CPU: 70%, Memory: 80%)"
          - "=========================================="
      until: mongodb_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Redis
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '{{ k8s_manifests_dir }}/redis-deployment.yaml') }}"
        namespace: "{{ namespace }}"

    - name: Wait for Redis to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: redis
        namespace: "{{ namespace }}"
      register: redis_status
      until: redis_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 20
      delay: 10

    - name: Update backend image in deployment
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: "{{ namespace }}"
          spec:
            template:
              spec:
                containers:
                - name: backend
                  image: "{{ backend_image }}:{{ image_tag }}"

    - name: Deploy Backend
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '{{ k8s_manifests_dir }}/backend-deployment.yaml') }}"
        namespace: "{{ namespace }}"

    - name: Wait for Backend to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: backend
        namespace: "{{ namespace }}"
      register: backend_status
      until: backend_status.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Update frontend image in deployment
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: "{{ namespace }}"
          spec:
            template:
              spec:
                containers:
                - name: frontend
                  image: "{{ frontend_image }}:{{ image_tag }}"

    - name: Deploy Frontend
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '{{ k8s_manifests_dir }}/frontend-deployment.yaml') }}"
        namespace: "{{ namespace }}"

    - name: Deploy Ingress
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', '{{ k8s_manifests_dir }}/ingress.yaml') }}"
        namespace: "{{ namespace }}"

    - name: Get deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
      register: deployments

    - name: Display deployment status
      debug:
        msg: "{{ item.metadata.name }}: {{ item.status.replicas }}/{{ item.status.readyReplicas | default(0) }} ready"
      loop: "{{ deployments.resources }}"

    - name: Get HPA status
      kubernetes.core.k8s_info:
        kind: HorizontalPodAutoscaler
        namespace: "{{ namespace }}"
      register: hpas

    - name: Display HPA status
      debug:
        msg: "{{ item.metadata.name }}: Current replicas: {{ item.status.currentReplicas | default(0) }}"
      loop: "{{ hpas.resources }}"

    - name: Get service endpoints
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ namespace }}"
      register: services

    - name: Display service endpoints
      debug:
        msg: "{{ item.metadata.name }}: {{ item.spec.type }} - {{ item.spec.clusterIP }}"
      loop: "{{ services.resources }}"
